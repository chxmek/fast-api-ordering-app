# üóÑÔ∏è Database Migration Guide (‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Schema Database)

## ‚ö° ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Alembic

**Alembic** ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ database schema migrations ‡πÅ‡∏ö‡∏ö automatic  
‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ö **Entity Framework Migrations** ‡πÉ‡∏ô SQL Server ‡∏´‡∏£‡∏∑‡∏≠ **Django Migrations**

### ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ
- ‚ú® **Auto-generate migrations** ‡∏à‡∏≤‡∏Å SQLAlchemy models
- üîÑ **Track schema changes** ‡∏î‡πâ‡∏ß‡∏¢ version control
- ‚¨ÜÔ∏è **Upgrade/Downgrade** database schema ‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢
- üåê **Works with cloud databases** (Supabase, AWS RDS, etc.)
- üë• **Team collaboration** - ‡∏ó‡∏µ‡∏°‡πÄ‡∏´‡πá‡∏ô schema changes ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô

---

## üìã ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô

### 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Migration ‡πÉ‡∏´‡∏°‡πà (Auto-generate)

‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç model ‡πÉ‡∏ô `app/models/` ‡πÅ‡∏•‡πâ‡∏ß:

```bash
# Activate virtual environment
source ../venv/bin/activate
cd fast-api-ordering-app

# Auto-generate migration from model changes
../venv/bin/alembic revision --autogenerate -m "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á"
```

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:**
```bash
../venv/bin/alembic revision --autogenerate -m "Add address field to User"
../venv/bin/alembic revision --autogenerate -m "Create product table"
```

### 2. ‡∏î‡∏π Migration History

```bash
../venv/bin/alembic history
```

### 3. ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

```bash
../venv/bin/alembic current
```

### 4. Apply Migrations (Upgrade)

```bash
# Apply ‡∏ó‡∏∏‡∏Å migrations ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ apply
../venv/bin/alembic upgrade head

# Apply migration ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ revision
../venv/bin/alembic upgrade <revision_id>

# Apply migration step by step (+1 = next migration)
../venv/bin/alembic upgrade +1
```

### 5. Rollback (Downgrade)

```bash
# Rollback 1 migration
../venv/bin/alembic downgrade -1

# Rollback ‡πÑ‡∏õ‡∏¢‡∏±‡∏á revision ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
../venv/bin/alembic downgrade <revision_id>

# Rollback ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏∞‡∏ß‡∏±‡∏á! ‡∏à‡∏∞‡∏•‡∏ö‡∏ó‡∏∏‡∏Å tables)
../venv/bin/alembic downgrade base
```

---

## üéØ Workflow ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

### ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå 1: ‡πÄ‡∏û‡∏¥‡πà‡∏° Column ‡πÉ‡∏´‡∏°‡πà

**1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Model:**

```python
# app/models/user.py
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(100), nullable=False)
    email = Column(String(100), unique=True, nullable=False, index=True)
    
    # üÜï ‡πÄ‡∏û‡∏¥‡πà‡∏° column ‡πÉ‡∏´‡∏°‡πà
    address = Column(String(500), nullable=True)
    date_of_birth = Column(Date, nullable=True)
```

**2. Generate Migration:**

```bash
../venv/bin/alembic revision --autogenerate -m "Add address and date_of_birth to users"
```

**3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Migration File:**

Alembic ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô `alembic/versions/xxxx_add_address_and_date_of_birth_to_users.py`

```python
def upgrade() -> None:
    # ### commands auto generated by Alembic ###
    op.add_column('users', sa.Column('address', sa.String(length=500), nullable=True))
    op.add_column('users', sa.Column('date_of_birth', sa.Date(), nullable=True))
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic ###
    op.drop_column('users', 'date_of_birth')
    op.drop_column('users', 'address')
    # ### end Alembic commands ###
```

**4. Apply to Cloud Database:**

```bash
../venv/bin/alembic upgrade head
```

‚úÖ **‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ Supabase database ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ columns ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß!**

---

### ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå 2: ‡∏™‡∏£‡πâ‡∏≤‡∏á Table ‡πÉ‡∏´‡∏°‡πà

**1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Model ‡πÉ‡∏´‡∏°‡πà:**

```python
# app/models/product.py
from sqlalchemy import Column, Integer, String, Float, Boolean
from app.db.database import Base

class Product(Base):
    __tablename__ = "products"
    
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(200), nullable=False)
    description = Column(String(1000))
    price = Column(Float, nullable=False)
    in_stock = Column(Boolean, default=True)
```

**2. Import Model ‡πÉ‡∏ô `app/models/__init__.py`:**

```python
from app.models.product import Product

__all__ = [
    # ... existing models
    "Product"
]
```

**3. Generate Migration:**

```bash
../venv/bin/alembic revision --autogenerate -m "Create products table"
```

**4. Apply:**

```bash
../venv/bin/alembic upgrade head
```

---

### ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå 3: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ Column

**‚ö†Ô∏è Alembic ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà detect ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ - ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç migration file ‡πÄ‡∏≠‡∏á**

**1. Generate empty migration:**

```bash
../venv/bin/alembic revision -m "Rename user phone to phone_number"
```

**2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç migration file:**

```python
def upgrade() -> None:
    op.alter_column('users', 'phone', new_column_name='phone_number')

def downgrade() -> None:
    op.alter_column('users', 'phone_number', new_column_name='phone')
```

**3. Apply:**

```bash
../venv/bin/alembic upgrade head
```

---

### ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå 4: ‡∏•‡∏ö Column

**1. ‡∏•‡∏ö‡∏à‡∏≤‡∏Å Model:**

```python
# app/models/user.py
class User(Base):
    # ...
    # ‡∏•‡∏ö line ‡∏ô‡∏µ‡πâ
    # deprecated_field = Column(String(100))
```

**2. Generate Migration:**

```bash
../venv/bin/alembic revision --autogenerate -m "Remove deprecated_field from users"
```

**3. Apply:**

```bash
../venv/bin/alembic upgrade head
```

---

## üöÄ Best Practices

### ‚úÖ DO

1. **Always review migration files** ‡∏Å‡πà‡∏≠‡∏ô apply
2. **Backup database** ‡∏Å‡πà‡∏≠‡∏ô run migrations ‡∏ö‡∏ô production
3. **Test migrations** ‡∏ö‡∏ô dev/staging environment ‡∏Å‡πà‡∏≠‡∏ô
4. **Write descriptive messages** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö migration names
5. **Commit migration files** ‡πÄ‡∏Ç‡πâ‡∏≤ Git
6. **Run migrations** ‡πÄ‡∏õ‡πá‡∏ô part of deployment process

### ‚ùå DON'T

1. **‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç migration files** ‡∏ó‡∏µ‡πà apply ‡πÅ‡∏•‡πâ‡∏ß
2. **‡∏´‡πâ‡∏≤‡∏° drop tables** ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà backup
3. **‡∏´‡πâ‡∏≤‡∏° force delete** migration files ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô database ‡πÅ‡∏•‡πâ‡∏ß
4. **‡∏´‡πâ‡∏≤‡∏° manual edit** database schema ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÉ‡∏ä‡πâ migrations ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)

---

## üîß Makefile Commands (‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏Å‡∏ß‡πà‡∏≤)

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô `Makefile`:

```makefile
# Database Migrations
.PHONY: migrate-create
migrate-create:
	@read -p "Enter migration message: " msg; \
	cd fast-api-ordering-app && ../venv/bin/alembic revision --autogenerate -m "$$msg"

.PHONY: migrate-up
migrate-up:
	cd fast-api-ordering-app && ../venv/bin/alembic upgrade head

.PHONY: migrate-down
migrate-down:
	cd fast-api-ordering-app && ../venv/bin/alembic downgrade -1

.PHONY: migrate-history
migrate-history:
	cd fast-api-ordering-app && ../venv/bin/alembic history

.PHONY: migrate-current
migrate-current:
	cd fast-api-ordering-app && ../venv/bin/alembic current
```

**‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:**

```bash
make migrate-create        # ‡∏™‡∏£‡πâ‡∏≤‡∏á migration ‡πÉ‡∏´‡∏°‡πà
make migrate-up           # Apply migrations
make migrate-down         # Rollback 1 migration
make migrate-history      # ‡∏î‡∏π history
make migrate-current      # ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
```

---

## üåê Deployment Workflow

### Development ‚Üí Production

**1. Development:**
```bash
# ‡πÅ‡∏Å‡πâ model
vim app/models/user.py

# ‡∏™‡∏£‡πâ‡∏≤‡∏á migration
make migrate-create

# ‡∏ó‡∏î‡∏™‡∏≠‡∏ö local
make migrate-up

# ‡∏ó‡∏î‡∏™‡∏≠‡∏ö app
python -m uvicorn main:app --reload
```

**2. Commit to Git:**
```bash
git add alembic/versions/*.py
git commit -m "Add migration: <description>"
git push
```

**3. Production Deployment:**
```bash
# Pull latest code
git pull

# Apply migrations
make migrate-up

# Restart server
# (Railway/Render ‡∏à‡∏∞ restart ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
```

---

## üêõ Troubleshooting

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: "Target database is not up to date"

```bash
# ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
../venv/bin/alembic current

# Apply missing migrations
../venv/bin/alembic upgrade head
```

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: "Can't locate revision identified by 'xxxxx'"

```bash
# Stamp database to specific revision
../venv/bin/alembic stamp head
```

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: Migration conflict

```bash
# ‡∏î‡∏π history
../venv/bin/alembic history

# Merge branches ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ multiple heads
../venv/bin/alembic merge -m "merge heads" <revision1> <revision2>
```

---

## üìö Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [Supabase + Alembic Guide](https://supabase.com/docs/guides/database/migrations)
- [SQLAlchemy Models Reference](https://docs.sqlalchemy.org/en/20/orm/declarative_tables.html)

---

## üéì ‡∏™‡∏£‡∏∏‡∏õ

‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ **Alembic** ‡∏ó‡∏≥‡πÉ‡∏´‡πâ:
- ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ database schema ‡πÅ‡∏ö‡∏ö version control ‡πÑ‡∏î‡πâ
- ‚úÖ Auto-sync ‡∏Å‡∏±‡∏ö cloud database (Supabase)
- ‚úÖ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å
- ‚úÖ Rollback ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤
- ‚úÖ Deployment ‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢

**‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Git ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Database!** üöÄ
